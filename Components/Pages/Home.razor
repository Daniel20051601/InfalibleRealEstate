@page "/"
@inject PropiedadService PropiedadesService
@rendermode InteractiveServer
@inject NotificationService NotificationService
@inject CarritoService carritoService
@inject AuthenticationStateProvider authenticationStateProvider
@inject UsuariosService UsuariosService


<PageTitle>Infalible Real Estate</PageTitle>

<section class="hero-section text-white d-flex align-items-center m-0 bgImg">
    <div class="container">

        <div class="row">
            <div class="col-lg-6">
                <div class="search-box position-relative bg-white rounded-4 shadow p-4 mt-5">

                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active " id="tab-buy">

                            <div class="icon-list d-flex overflow-auto justify-content-between mb-4 iconBg ">
                                <div class="icon-item text-center flex-shrink-0 me-3 p-2">
                                    <i class="bi bi-grid fs-4"></i>
                                    <small class="d-block textZ">Todos</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0 me-3">
                                    <i class="bi bi-building fs-4"></i>
                                    <small class="d-block textZ">Apartamentos</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0 me-3">
                                    <i class="bi bi-house fs-4"></i>
                                    <small class="d-block textZ">Casas</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0 me-3">
                                    <i class="bi bi-tree fs-4"></i>
                                    <small class="d-block textZ">Solares</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0 me-3">
                                    <i class="bi bi-building-up fs-4"></i>
                                    <small class="d-block textZ">Penthouse</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0 me-3">
                                    <i class="bi bi-house-door fs-4"></i>
                                    <small class="d-block textZ">Villas</small>
                                </div>
                                <div class="icon-item text-center flex-shrink-0">
                                    <i class="bi bi-shop fs-4"></i>
                                    <small class="d-block textZ">Locales</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <div class="">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info">Venta</button>
                                        <button type="button" class="btn btn-outline-info">Alquiler</button>
                                    </div>
                                </div>
                                <div class="">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info">RD$</button>
                                        <button type="button" class="btn btn-outline-info">US$</button>
                                    </div>
                                </div>
                            </div>


                            <div class="mb-1">
                                <input type="range" class="form-range" min="0" max="40000000" step="1000000">
                            </div>
                            <div class="mb-3 text-center">
                                <small class="text-muted">RD$ 0 hasta RD$40,000,000</small>
                            </div>
                            <div class="d-flex justify-content-center">
                                <a href="/Propiedad/Catalogo" class="btn btn-primary btn-sm">
                                    <i class="bi bi-search"></i> Buscar
                                </a>
                            </div>


                        </div>

                        <div class="tab-pane fade" id="tab-rent">
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<section class="ultimas-publicaciones-section container">
    <div class="d-flex justify-content-center">
        <div class="ultimas-header-inner w-100">
            <div class="d-flex align-items-center mb-4 px-3">
                <h2 class="ultimas-title mb-0">
                    <span class="fw-semibold">&Uacute;ltimas</span> <span class="text-danger fw-semibold">Publicaciones</span>
                </h2>
            </div>
        </div>
    </div>
    <div class="row flex-nowrap overflow-auto ultimas-cards-row pb-3 mx-0 px-0"
         @ref="carouselRef">
        @if (ultimasPropiedades is null)
        {
            <div class="d-flex flex-column align-items-center">
                <div>
                    <div class="spinner-grow text-primary mx-1" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="spinner-grow text-primary mx-1" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="spinner-grow text-primary mx-1" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            @foreach (var propiedad in ultimasPropiedades)
            {
                <div class="col-10 col-sm-6 col-md-4 col-lg-3 col-xl-3 me-3 ultimas-card-col">
                    <a href="/Propiedad/Detalle/@propiedad.PropiedadId">
                        <div class="card ultimas-card h-100">
                            @if (propiedad.Imagenes?.Any() == true)
                            {
                                <img src="@propiedad.Imagenes.FirstOrDefault()?.UrlImagen"
                                     class="card-img-top ultimas-card-img"
                                     alt="@propiedad.Titulo">
                            }
                            else
                            {
                                <div class="card-img-top ultimas-card-img bg-light d-flex align-items-center justify-content-center">
                                    <i class="bi bi-house text-muted" style="font-size: 3rem;"></i>
                                </div>
                            }

                            <div class="card-body p-3">
                                <div class="d-flex justify-content-end mb-2">
                                    <small class="badge bg-info">@propiedad.TipoTransaccion</small>
                                </div>
                                <h5 class="card-title ultimas-card-title text-truncate">@propiedad.Titulo</h5>
                                @if (!string.IsNullOrWhiteSpace(propiedad.Detalle?.Descripcion))
                                {
                                    <p class="card-text ultimas-card-desc">
                                        @((propiedad.Detalle.Descripcion.Length > 80)
                                                                    ? propiedad.Detalle.Descripcion.Substring(0, 80) + "..."
                                                                    : propiedad.Detalle.Descripcion)
                        </p>
                                                }
                            </div>
                            <div class="card-footer bg-white border-0 d-flex pt-0 flex-column align-items-center">
                                <div class="mt-2 mb-2">
                                    <small class="text-muted"><span class="bi bi-geo-alt"></span> @propiedad.Ciudad</small>
                                </div>
                                <div class="d-flex justify-content-center align-items-center mb-2 gap-3">
                                    <span class="text-secondary d-flex align-items-center">
                                        @if (propiedad.Detalle?.MetrosCuadrados != null && propiedad.Detalle?.MetrosCuadrados != 0)
                                        {
                                            <span class="text-secondary d-flex align-items-center justify-content-between">
                                                <i class="bi bi-fullscreen ultimas-icon-tamano-v"></i>
                                            </span>
                                            <span class="ms-1 ultimas-icon-tamano">@propiedad.Detalle?.MetrosCuadrados m²</span>
                                        }
                                    </span>
                                    <span class="text-secondary d-flex align-items-center">
                                        @if (propiedad.Detalle?.Habitaciones != null && propiedad.Detalle?.Habitaciones != 0)
                                        {
                                            <span class="material-symbols-outlined ultimas-icon">
                                                airline_seat_flat
                                            </span>
                                            <span class="ms-1 ultimas-icon-tamano">@propiedad.Detalle?.Habitaciones</span>
                                        }
                                    </span>
                                    <span class="text-secondary d-flex align-items-center">
                                        @if (propiedad.Detalle?.Banos != null && propiedad.Detalle?.Banos != 0)
                                        {
                                            <span class="material-symbols-outlined ultimas-icon">
                                                shower
                                            </span>
                                            <span class="ms-1 ultimas-icon-tamano">@propiedad.Detalle?.Banos</span>
                                        }
                                    </span>
                                    <span class="text-secondary d-flex align-items-center">
                                        @if (propiedad.Detalle?.Parqueo != null && propiedad.Detalle?.Parqueo != 0)
                                        {
                                            <span class="material-symbols-outlined ultimas-icon">
                                                directions_car
                                            </span>
                                            <span class="ms-1 ultimas-icon-tamano">@propiedad.Detalle?.Parqueo</span>
                                        }
                                    </span>
                                </div>
                                <span class="ultimas-card-price">@(propiedad.Moneda == "Dolar" ? "USD$" : "DOP$") @propiedad.Precio.ToString("N2")</span>
                            </div>
                        </div>
                    </a>
                    <button type="button"
                            class="btn btn-fav position-absolute top-0 end-0 m-2"
                            title="Agregar al carrito"
                            @onclick="() => AgregarAlCarrito(propiedad.PropiedadId)">
                        <i class="bi bi-cart"></i>
                    </button>
                </div>

            }
        }
    </div>
</section>

<section class="servicios-section mt-3">
    <div class="container">
        <div class="text-center">
            <div class="servicios-content">
                <div class="text-center d-flex justify-content-center mb-4">
                    <h2 class="fw-bold">
                        Ofrecemos un
                        <span class="text-danger fw-bold">Servicio Integral</span> de Asesor&iacute;a Inmobiliaria
                    </h2>
                </div>

                <div class="row mb-3">

                    <div class="servicio-item col-md-6">
                        <img class="serviciosImg mb-2 " src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionServicios/Ilustraciones/AsesoriaRojo.649Z-Photoroom.png" />
                        <h3 class="servicio-titulo text-cyan ">ASESORÍA INMOBILIARIA</h3>
                        <p class="servicio-descripcion ">
                            Servicios de asesoría inmobiliaria muy completo:<br>
                            Compra, Venta, y Renta de bienes inmuebles,<br>
                            acompañamiento en la gestión de transacciones.
                        </p>
                    </div>

                    <div class="servicio-item  col-md-6">
                        <img class="serviciosImg mb-1" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionServicios/Ilustraciones/InversionRojo.png" />
                        <h3 class="servicio-titulo text-cyan">ELABORACIÓN DE PROCESO<br>DE INVERSIÓN</h3>
                        <p class="servicio-descripcion">
                            Asesoría de inversión y planificación patrimonial<br>
                            para hacer crecer tus ingresos.
                        </p>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="servicio-item col-md-6">
                        <img class="serviciosImg mb-2" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionServicios/Ilustraciones/PrecososLegalesRojo.559Z.png" />
                        <h3 class="servicio-titulo text-cyan ">SERVICIOS LEGALES Y<br>NOTARIALES</h3>
                        <p class="servicio-descripcion ">
                            Acompañamiento y asesoramiento a cargo de un equipo<br>
                            de profesionales del derecho, además de contar<br>
                            con la garantía y seguridad en cada acto que<br>
                            instrumentan nuestros notarios públicos.
                        </p>
                    </div>

                    <div class="servicio-item col-md-6">
                        <img class="serviciosImg mb-1" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionServicios/Ilustraciones/PromocionRojo.170Z.png" />
                        <h3 class="servicio-titulo mb-2  text-cyan">PROMOCIÓN Y ACOMPAÑAMIENTO</h3>
                        <p class="servicio-descripcion ">
                            Agilizamos las transacciones comerciales de bienes<br>
                            raíces, apoyándonos en una herramienta poderosa, la<br>
                            publicidad a través de diferentes canales de promoción.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<section class="mb-3">
    <div class="articulos-section py-5" style="background-color: #1E1E1E;">
        <div class="container">
            <div class="d-flex flex-column align-items-center justify-content-center text-center">
                <h2 class="mb-3 fw-semibold text-white">Sobre nosotros</h2>
                <p class="mb-4 text-white" style="max-width: 900px;">
                    En Infalible Real Estate, transformamos espacios en oportunidades y
                    propiedades en hogares. Nos dedicamos con pasión a conectar personas con
                    lugares donde puedan construir su historia, invertir con confianza o simplemente
                    comenzar un nuevo capítulo. Con sede en San Francisco de Macorís, ofrecemos un servicio
                    cercano, profesional y honesto, acompañándote en cada paso del proceso. Porque más que vender inmuebles, ubicamos tus sueños.
                </p>
                <a href="/unete" class="btn btn-light px-4 py-2 rounded-pill">¡Únete al equ&iacute;po!</a>
            </div>
        </div>
    </div>
</section>

<section class="mb-3 sectionCanalYoutube">
    <div class="container text-center py-5">
        <h2 class="fw-bold">
            Visita Nuestro
            <span class="text-danger fw-bold"> Canal de YouTube</span>
        </h2>
        <div>
            <p class="mb-2">
                Descubre nuestro canal de YouTube, donde puedes ver los videos de todas nuestras propiedades. ¡Suscríbete y mantente al día con las últimas actualizaciones!
            </p>
        </div>
        <div>
            <iframe class="youtube-iframe iframeYoutube mt-4" src="https://www.youtube.com/embed/k0_LSJHoMd4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
        <div class="d-flex justify-content-center mt-2">
            <a href="https://www.youtube.com/@@infaliblerealestate479" target="_blank" class="btn btn-danger px-4 py-2 rounded-pill">
                <i class="bi bi-youtube mx-1"></i> Visita nuestro canal
            </a>
        </div>


    </div>

</section>

<section class="equipo-section mb-5">
    <div class="container">
        <div class="equipo-content">
            <div class="equipo-header mb-4">
                <h2 class="fw-bold">
                    Explora nuestro
                    <span class="text-danger fw-bold"> C&aacute;talogo</span> de propiedades
                </h2>
            </div>
        </div>

        <div class="catalog-cards-row mb-4">
            <div class="catalog-card catalog-card-large">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/Casa.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Casas</h2>
                </div>
            </div>
            <div class="catalog-card catalog-card-small">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/proyectos.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Proyectos</h2>
                </div>
            </div>
        </div>
        <div class="catalog-cards-row mb-4">
            <div class="catalog-card catalog-card-small">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/Villas.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Villas</h2>
                </div>
            </div>
            <div class="catalog-card catalog-card-large">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/penthouse.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Penthouses</h2>
                </div>
            </div>

        </div>
        <div class="catalog-cards-row mb-4">
            <div class="catalog-card catalog-card-large">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/terrenos.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Terrenos</h2>
                </div>
            </div>
            <div class="catalog-card catalog-card-small">
                <img class="catalog-card-img" src="https://scrgajdklzafafwrxrng.supabase.co/storage/v1/object/public/propiedades/SeccionCatalogo/Locales.jpg" alt="Card image">
                <div class="catalog-card-overlay"></div>
                <div class="catalog-card-content">
                    <h2 class="catalog-card-title">Locales comerciales</h2>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2 col-4 mx-auto">
            <a href="/Propiedad/Catalogo" class="btn btn-primary btn-lg p-3">
                Cat&aacute;logo completo
            </a>
        </div>
    </div>
</section>

@if (mostrarModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="display: block; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body ">
                    <InfalibleRealEstate.Components.Pages.PropiedadesPages.ModalIniciaSesion @bind-mostrarModal="mostrarModal" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Propiedad>? ultimasPropiedades;
    private ElementReference carouselRef;
    private ApplicationUser? user;
    public bool mostrarModal { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            ultimasPropiedades = await PropiedadesService.GetUltimasPropiedadesAsync(5);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar propiedades: {ex.Message}");
            ultimasPropiedades = new List<Propiedad>();
        }
    }
    private void CerrarModalCita()
    {
        mostrarModal = false;
    }


    private async Task AgregarAlCarrito(int propiedadId)
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var claimsUser = authState.User;

        if (claimsUser.Identity is not null && claimsUser.Identity.IsAuthenticated)
        {
            var userId = claimsUser.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userId))
            {
                bool guardado = await carritoService.Agregar(userId, propiedadId);

                if (guardado)
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Éxito", Detail = "Propiedad agregada al carrito.", Duration = 4000 });
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Detail = "La propiedad ya está en el carrito.", Duration = 4000, ShowProgress = true, CloseOnClick = true });
                }
            }
            else
            {
                mostrarModal = true;
            }
        }
        else
        {
            mostrarModal = true;
        }
    }

}



